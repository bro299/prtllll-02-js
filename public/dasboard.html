<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“Š Dashboard - Portal Data DPR RI (Database Baru)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.6s ease-out',
                        'count-up': 'countUp 2s ease-out',
                        'pulse-soft': 'pulse 3s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        countUp: {
                            '0%': { transform: 'scale(0.5)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    },
                    screens: {
                        'xs': '320px',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    
    <!-- Navigation -->
    <nav class="bg-white/90 backdrop-blur-md shadow-lg sticky top-0 z-50 border-b border-indigo-100">
    <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8">
        <div class="flex justify-between items-center h-12 sm:h-16">
            <div class="flex items-center space-x-1 sm:space-x-4 min-w-0 flex-1">
                <i class="fas fa-chart-bar text-lg sm:text-2xl text-indigo-600 flex-shrink-0"></i>
                <h1 class="text-sm sm:text-xl font-bold text-gray-800 truncate">Dashboard DPR RI</h1>
                <span class="hidden md:inline-block bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full font-semibold">NEW DB</span>
            </div>
            <div class="flex items-center space-x-1 sm:space-x-4">
                <!-- Tombol ke Web 1 -->
                <a href="http://portal-dpr-new.onrender.com" class="bg-orange-100 hover:bg-orange-200 text-orange-600 font-medium transition-colors duration-200 flex items-center px-2 py-1 rounded-lg" title="Dashboard Web Lama">
                    <i class="fas fa-arrow-left text-sm sm:text-base"></i>
                    <span class="hidden sm:inline ml-1 text-xs sm:text-sm">Web 1</span>
                </a>
                
                <a href="/" class="text-gray-600 hover:text-indigo-600 font-medium transition-colors duration-200 flex items-center px-2 py-1 rounded-lg">
                    <i class="fas fa-search text-sm sm:text-base"></i>
                    <span class="hidden sm:inline ml-1 text-sm sm:text-base">Pencarian</span>
                </a>
                <a href="dasboard.html" class="text-indigo-600 hover:text-indigo-800 font-medium transition-colors duration-200 flex items-center px-2 py-1 rounded-lg">
                    <i class="fas fa-chart-bar text-sm sm:text-base"></i>
                    <span class="hidden sm:inline ml-1 text-sm sm:text-base">Dashboard</span>
                </a>
            </div>
        </div>
    </div>
</nav>

    <!-- Header -->
    <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-6 sm:py-12">
        <div class="text-center animate-slide-up">
            <h1 class="text-3xl xs:text-4xl sm:text-5xl font-bold text-gray-800 mb-4 sm:mb-6">
                ðŸ“Š Dashboard Analytics DPR RI
            </h1>
            <p class="text-lg sm:text-xl text-gray-600 mb-6 sm:mb-8 px-2">
                Visualisasi Data Anggota DPR dengan Database Terbaru
            </p>
            <div class="inline-flex items-center space-x-3 bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm sm:text-base font-semibold">
                <span class="w-2 h-2 sm:w-3 sm:h-3 bg-blue-500 rounded-full animate-pulse-soft"></span>
                <span>Real-time Analytics â€¢ 6700+ Records</span>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-6 sm:py-12">
        <div class="text-center">
            <div class="inline-flex items-center space-x-4 bg-white/80 backdrop-blur-sm rounded-2xl p-6 shadow-lg">
                <div class="animate-spin rounded-full h-10 w-10 sm:h-16 sm:w-16 border-4 border-indigo-600 border-t-transparent"></div>
                <div class="text-left">
                    <p class="text-lg sm:text-xl text-gray-700 font-medium">Memuat dashboard...</p>
                    <p class="text-sm text-gray-500">Menganalisis data terbaru</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" class="hidden max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 pb-6 sm:pb-12">
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8 sm:mb-12">
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-4 sm:p-6 border border-white/40 animate-fade-in hover:shadow-2xl transition-all duration-300">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-3 sm:mb-0">
                        <p class="text-xs sm:text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Anggota</p>
                        <p id="totalMembers" class="text-2xl sm:text-3xl font-bold text-indigo-600 animate-count-up">0</p>
                    </div>
                    <div class="bg-indigo-100 rounded-full p-3 sm:p-4 w-10 h-10 sm:w-14 sm:h-14 flex items-center justify-center">
                        <i class="fas fa-users text-indigo-600 text-lg sm:text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-4 sm:p-6 border border-white/40 animate-fade-in hover:shadow-2xl transition-all duration-300">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-3 sm:mb-0">
                        <p class="text-xs sm:text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Fraksi</p>
                        <p id="totalFraksi" class="text-2xl sm:text-3xl font-bold text-green-600 animate-count-up">0</p>
                    </div>
                    <div class="bg-green-100 rounded-full p-3 sm:p-4 w-10 h-10 sm:w-14 sm:h-14 flex items-center justify-center">
                        <i class="fas fa-flag text-green-600 text-lg sm:text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-4 sm:p-6 border border-white/40 animate-fade-in hover:shadow-2xl transition-all duration-300">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-3 sm:mb-0">
                        <p class="text-xs sm:text-sm font-semibold text-gray-500 uppercase tracking-wide">Total Provinsi</p>
                        <p id="totalProvinsi" class="text-2xl sm:text-3xl font-bold text-purple-600 animate-count-up">0</p>
                    </div>
                    <div class="bg-purple-100 rounded-full p-3 sm:p-4 w-10 h-10 sm:w-14 sm:h-14 flex items-center justify-center">
                        <i class="fas fa-map text-purple-600 text-lg sm:text-2xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-4 sm:p-6 border border-white/40 animate-fade-in hover:shadow-2xl transition-all duration-300">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-3 sm:mb-0">
                        <p class="text-xs sm:text-sm font-semibold text-gray-500 uppercase tracking-wide">Rata-rata Usia</p>
                        <p id="avgAge" class="text-2xl sm:text-3xl font-bold text-orange-600 animate-count-up">0</p>
                    </div>
                    <div class="bg-orange-100 rounded-full p-3 sm:p-4 w-10 h-10 sm:w-14 sm:h-14 flex items-center justify-center">
                        <i class="fas fa-calendar text-orange-600 text-lg sm:text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8 mb-8 sm:mb-12">
            <!-- Fraksi Distribution Chart -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 sm:p-8 border border-white/40 animate-fade-in">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 flex items-center">
                    <i class="fas fa-flag mr-3 text-blue-600"></i>
                    <span>Distribusi per Fraksi</span>
                </h3>
                <div class="relative h-64 sm:h-80">
                    <canvas id="fraksiChart"></canvas>
                </div>
            </div>

            <!-- Province Distribution Chart -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 sm:p-8 border border-white/40 animate-fade-in">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 flex items-center">
                    <i class="fas fa-map-marked-alt mr-3 text-green-600"></i>
                    <span>Top 10 Provinsi</span>
                </h3>
                <div class="relative h-64 sm:h-80">
                    <canvas id="provinsiChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Second Row Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8 mb-8 sm:mb-12">
            <!-- Jabatan Distribution Chart -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 sm:p-8 border border-white/40 animate-fade-in">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 flex items-center">
                    <i class="fas fa-briefcase mr-3 text-purple-600"></i>
                    <span>Distribusi Jabatan</span>
                </h3>
                <div class="relative h-64 sm:h-80">
                    <canvas id="jabatanChart"></canvas>
                </div>
            </div>

            <!-- Age Distribution Chart -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 sm:p-8 border border-white/40 animate-fade-in">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 flex items-center">
                    <i class="fas fa-calendar-alt mr-3 text-orange-600"></i>
                    <span>Distribusi Usia</span>
                </h3>
                <div class="relative h-64 sm:h-80">
                    <canvas id="usiaChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Leadership and Gender Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8 mb-8 sm:mb-12">
            <!-- Leadership Distribution -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 sm:p-8 border border-white/40 animate-fade-in">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 flex items-center">
                    <i class="fas fa-crown mr-3 text-yellow-600"></i>
                    <span>Distribusi Kepemimpinan</span>
                </h3>
                <div class="relative h-64 sm:h-80">
                    <canvas id="leadershipChart"></canvas>
                </div>
            </div>

            <!-- Gender Distribution -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 sm:p-8 border border-white/40 animate-fade-in">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 flex items-center">
                    <i class="fas fa-venus-mars mr-3 text-pink-600"></i>
                    <span>Distribusi Gender (Estimasi)</span>
                </h3>
                <div class="relative h-64 sm:h-80">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top Lists Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8 mb-8 sm:mb-12">
            <!-- Top Fraksi -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 sm:p-8 border border-white/40 animate-fade-in">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 flex items-center">
                    <i class="fas fa-trophy mr-3 text-yellow-500"></i>
                    <span>Top 5 Fraksi</span>
                </h3>
                <div id="topFraksi" class="space-y-3 sm:space-y-4">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <!-- Top Provinsi -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 sm:p-8 border border-white/40 animate-fade-in">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 flex items-center">
                    <i class="fas fa-medal mr-3 text-blue-500"></i>
                    <span>Top 5 Provinsi</span>
                </h3>
                <div id="topProvinsi" class="space-y-3 sm:space-y-4">
                    <!-- Will be populated by JS -->
                </div>
            </div>

            <!-- Leadership Stats -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 sm:p-8 border border-white/40 animate-fade-in md:col-span-2 lg:col-span-1">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 flex items-center">
                    <i class="fas fa-users-cog mr-3 text-indigo-500"></i>
                    <span>Statistik Jabatan</span>
                </h3>
                <div id="leadershipStats" class="space-y-3 sm:space-y-4">
                    <!-- Will be populated by JS -->
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-xl p-6 sm:p-8 border border-white/40 animate-fade-in">
            <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-download mr-3 text-indigo-600"></i>
                <span>Export Data</span>
            </h3>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                <button id="exportCSV" class="flex items-center justify-center px-6 py-4 bg-green-100 hover:bg-green-200 text-green-800 rounded-xl transition-colors text-base font-semibold shadow-lg hover:shadow-xl">
                    <i class="fas fa-table mr-3 text-xl"></i>
                    <span>Download CSV</span>
                </button>
                
                <button id="refreshData" class="flex items-center justify-center px-6 py-4 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-xl transition-colors text-base font-semibold shadow-lg hover:shadow-xl">
                    <i class="fas fa-sync-alt mr-3 text-xl"></i>
                    <span>Refresh Dashboard</span>
                </button>
            </div>
            
            <div id="exportProgress" class="hidden mt-6">
                <div class="bg-gray-200 rounded-full h-3">
                    <div id="exportProgressBar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-600 mt-3 text-center" id="exportStatus">Preparing export...</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-gray-800 to-gray-900 text-white py-8 sm:py-12 mt-12 sm:mt-16">
        <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 text-center">
            <div class="mb-6">
                <h3 class="text-xl sm:text-2xl font-bold mb-2">Dashboard DPR RI</h3>
                <p class="text-sm sm:text-base text-gray-300">Real-time Analytics â€¢ Database Terbaru â€¢ Powered by Chart.js</p>
            </div>
            <div class="border-t border-gray-700 pt-6">
                <p class="text-sm sm:text-base">
                    &copy; 2025 Portal Data DPR RI â€¢ Modern Dashboard Technology
                </p>
            </div>
        </div>
    </footer>

    <script>
        // Enhanced Dashboard for New Database Schema
        class DPRDashboard {
            constructor() {
                this.loading = document.getElementById('loading');
                this.dashboardContent = document.getElementById('dashboardContent');
                this.charts = {};
                
                // API Configuration
                this.API_CONFIG = {
                    LOCAL_URL: 'http://localhost:3000',
                    PRODUCTION_URL: 'https://portal-dpr-new2.onrender.com',
                    
                    get BASE_URL() {
                        return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
                            ? this.LOCAL_URL 
                            : this.PRODUCTION_URL;
                    },
                    
                    ENDPOINTS: {
                        STATS: '/api/stats',
                        EXPORT: '/api/export'
                    }
                };
                
                this.initDashboard();
            }

            async initDashboard() {
                try {
                    this.showLoading();
                    const stats = await this.fetchStats();
                    this.hideLoading();
                    
                    this.updateStatsCards(stats);
                    this.createCharts(stats);
                    this.updateTopLists(stats);
                    this.setupEventListeners();
                    
                } catch (error) {
                    console.error('Dashboard error:', error);
                    this.hideLoading();
                    this.showError('Gagal memuat data dashboard: ' + (error.message || 'Unknown error'));
                }
            }

            async fetchStats() {
                try {
                    const response = await fetch(`${this.API_CONFIG.BASE_URL}${this.API_CONFIG.ENDPOINTS.STATS}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.message || 'Failed to fetch stats');
                    }
                    
                    return data.data;
                } catch (error) {
                    console.error('Failed to fetch stats:', error);
                    throw error;
                }
            }

            showLoading() {
                this.loading.classList.remove('hidden');
                this.dashboardContent.classList.add('hidden');
            }

            hideLoading() {
                this.loading.classList.add('hidden');
                this.dashboardContent.classList.remove('hidden');
            }

            showError(message) {
                this.loading.innerHTML = `
                    <div class="text-center">
                        <div class="bg-red-100 border-2 border-red-300 text-red-700 px-6 sm:px-8 py-6 sm:py-8 rounded-2xl shadow-lg max-w-2xl mx-auto">
                            <i class="fas fa-exclamation-triangle text-3xl sm:text-4xl mb-4"></i>
                            <h3 class="text-lg sm:text-xl font-bold mb-2">Terjadi Kesalahan</h3>
                            <p class="text-base sm:text-lg">${message}</p>
                            <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                Coba Lagi
                            </button>
                        </div>
                    </div>
                `;
            }

            updateStatsCards(stats) {
                // Get total members
                const totalMembers = stats.total && stats.total[0] ? stats.total[0].count : 0;
                
                // Count unique fraksi (excluding null/empty)
                const totalFraksi = stats.byFraksi ? 
                    stats.byFraksi.filter(f => f.fraksi && f.fraksi !== '' && f.fraksi !== 'Tidak Ada Fraksi').length : 0;
                
                // Count unique provinces
                const totalProvinsi = stats.byProvinsi ? stats.byProvinsi.length : 0;
                
                // Calculate average age
                const avgAge = stats.avgAge && stats.avgAge[0] ? Math.round(stats.avgAge[0].avg_age) : 0;
                
                // Animate count up
                this.animateCountUp('totalMembers', totalMembers);
                this.animateCountUp('totalFraksi', totalFraksi);
                this.animateCountUp('totalProvinsi', totalProvinsi);
                this.animateCountUp('avgAge', avgAge, ' th');
            }

            animateCountUp(elementId, targetValue, suffix = '') {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                const duration = 2000;
                const startTime = performance.now();
                const startValue = 0;

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    const easeOut = 1 - Math.pow(1 - progress, 3);
                    const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOut);
                    
                    element.textContent = currentValue + suffix;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                
                requestAnimationFrame(animate);
            }

            createCharts(stats) {
                this.createFraksiChart(stats.byFraksi || []);
                this.createProvinsiChart(stats.byProvinsi || []);
                this.createJabatanChart(stats.byJabatan || []);
                this.createUsiaChart(stats.byUsia || []);
                this.createLeadershipChart(stats.leadership || []);
                this.createGenderChart(stats.byGender || []);
            }

            createFraksiChart(data) {
                const ctx = document.getElementById('fraksiChart');
                if (!ctx) return;

                // Filter out empty fraksi and take top 10
                const validData = data.filter(item => 
                    item.fraksi && 
                    item.fraksi !== '' && 
                    item.fraksi !== 'Tidak Ada Fraksi' && 
                    item.count > 0
                ).slice(0, 10);

                if (validData.length === 0) {
                    this.showNoDataChart(ctx, 'Tidak ada data fraksi');
                    return;
                }

                this.charts.fraksi = new Chart(ctx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: validData.map(item => this.truncateLabel(item.fraksi, 15)),
                        datasets: [{
                            data: validData.map(item => item.count),
                            backgroundColor: [
                                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                                '#06B6D4', '#F97316', '#84CC16', '#EC4899', '#6366F1'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: {
                                        size: window.innerWidth < 640 ? 10 : 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed * 100) / total).toFixed(1);
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            createProvinsiChart(data) {
                const ctx = document.getElementById('provinsiChart');
                if (!ctx) return;

                // Take top 10 provinces
                const topProvinsi = data.slice(0, 10);

                if (topProvinsi.length === 0) {
                    this.showNoDataChart(ctx, 'Tidak ada data provinsi');
                    return;
                }

                this.charts.provinsi = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: topProvinsi.map(item => this.truncateLabel(item.provinsi, window.innerWidth < 640 ? 8 : 12)),
                        datasets: [{
                            label: 'Jumlah Anggota',
                            data: topProvinsi.map(item => item.count),
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: 'rgb(16, 185, 129)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    font: { size: window.innerWidth < 640 ? 10 : 12 }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: window.innerWidth < 640 ? 90 : 45,
                                    font: { size: window.innerWidth < 640 ? 9 : 11 }
                                }
                            }
                        }
                    }
                });
            }

            createJabatanChart(data) {
                const ctx = document.getElementById('jabatanChart');
                if (!ctx) return;

                // Take top 8 positions
                const topJabatan = data.slice(0, 8);

                if (topJabatan.length === 0) {
                    this.showNoDataChart(ctx, 'Tidak ada data jabatan');
                    return;
                }

                this.charts.jabatan = new Chart(ctx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: topJabatan.map(item => this.truncateLabel(item.jabatan, 12)),
                        datasets: [{
                            data: topJabatan.map(item => item.count),
                            backgroundColor: [
                                '#8B5CF6', '#06B6D4', '#10B981', '#F59E0B',
                                '#EF4444', '#EC4899', '#84CC16', '#6366F1'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: { size: window.innerWidth < 640 ? 9 : 11 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed * 100) / total).toFixed(1);
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            createUsiaChart(data) {
                const ctx = document.getElementById('usiaChart');
                if (!ctx) return;

                if (!data || data.length === 0) {
                    this.showNoDataChart(ctx, 'Tidak ada data usia');
                    return;
                }

                // Sort by logical age order
                const sortedData = data.sort((a, b) => {
                    const order = {
                        'Di bawah 30': 1,
                        '30-40 tahun': 2,
                        '41-50 tahun': 3,
                        '51-60 tahun': 4,
                        'Di atas 60': 5,
                        'Tidak Diketahui': 6
                    };
                    return (order[a.kategori_usia] || 7) - (order[b.kategori_usia] || 7);
                });

                this.charts.usia = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: sortedData.map(item => 
                            window.innerWidth < 640 ? 
                            item.kategori_usia.replace(' tahun', '') : 
                            item.kategori_usia
                        ),
                        datasets: [{
                            label: 'Jumlah Anggota',
                            data: sortedData.map(item => item.count),
                            backgroundColor: [
                                '#8B5CF6', '#06B6D4', '#10B981', 
                                '#F59E0B', '#EF4444', '#6B7280'
                            ],
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    font: { size: window.innerWidth < 640 ? 10 : 12 }
                                }
                            },
                            x: {
                                ticks: {
                                    maxRotation: window.innerWidth < 640 ? 90 : 45,
                                    font: { size: window.innerWidth < 640 ? 9 : 11 }
                                }
                            }
                        }
                    }
                });
            }

            createLeadershipChart(data) {
                const ctx = document.getElementById('leadershipChart');
                if (!ctx) return;

                if (!data || data.length === 0) {
                    this.showNoDataChart(ctx, 'Tidak ada data kepemimpinan');
                    return;
                }

                this.charts.leadership = new Chart(ctx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: data.map(item => item.jabatan_type),
                        datasets: [{
                            data: data.map(item => item.count),
                            backgroundColor: ['#F59E0B', '#EF4444', '#3B82F6'],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: { size: window.innerWidth < 640 ? 10 : 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed * 100) / total).toFixed(1);
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            createGenderChart(data) {
                const ctx = document.getElementById('genderChart');
                if (!ctx) return;

                if (!data || data.length === 0) {
                    this.showNoDataChart(ctx, 'Tidak ada data gender');
                    return;
                }

                this.charts.gender = new Chart(ctx.getContext('2d'), {
                    type: 'pie',
                    data: {
                        labels: data.map(item => item.gender),
                        datasets: [{
                            data: data.map(item => item.count),
                            backgroundColor: ['#3B82F6', '#EC4899', '#6B7280'],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: { size: window.innerWidth < 640 ? 10 : 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed * 100) / total).toFixed(1);
                                        return `${context.label}: ${context.parsed} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            updateTopLists(stats) {
                this.updateTopFraksi((stats.byFraksi || []).slice(0, 5));
                this.updateTopProvinsi((stats.byProvinsi || []).slice(0, 5));
                this.updateLeadershipStats(stats.leadership || []);
            }

            updateTopFraksi(data) {
                const container = document.getElementById('topFraksi');
                if (!container) return;

                // Filter out empty fraksi
                const validData = data.filter(item => 
                    item.fraksi && 
                    item.fraksi !== '' && 
                    item.fraksi !== 'Tidak Ada Fraksi' && 
                    item.count > 0
                );

                if (validData.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">Data tidak tersedia</div>';
                    return;
                }

                const total = validData.reduce((sum, item) => sum + item.count, 0);

                container.innerHTML = validData.map((item, index) => {
                    const percentage = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                    const colors = ['bg-yellow-500', 'bg-gray-400', 'bg-amber-600', 'bg-blue-500', 'bg-green-500'];
                    const maxLength = window.innerWidth < 640 ? 12 : 20;

                    return `
                        <div class="flex items-center justify-between p-3 sm:p-4 bg-white rounded-xl shadow-sm border animate-slide-up hover:shadow-md transition-all duration-200" 
                             style="animation-delay: ${index * 100}ms">
                            <div class="flex items-center space-x-3 min-w-0 flex-1">
                                <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full ${colors[index]} flex items-center justify-center text-white font-bold text-sm sm:text-base flex-shrink-0">
                                    ${index + 1}
                                </div>
                                <div class="min-w-0 flex-1">
                                    <p class="font-semibold text-gray-800 text-sm sm:text-base truncate" title="${item.fraksi}">
                                        ${this.truncateLabel(item.fraksi, maxLength)}
                                    </p>
                                    <p class="text-xs text-gray-500">${percentage}% dari total</p>
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <p class="font-bold text-gray-800 text-base sm:text-lg">${item.count}</p>
                                <p class="text-xs text-gray-500">anggota</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateTopProvinsi(data) {
                const container = document.getElementById('topProvinsi');
                if (!container) return;

                if (data.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">Data tidak tersedia</div>';
                    return;
                }

                const total = data.reduce((sum, item) => sum + item.count, 0);

                container.innerHTML = data.map((item, index) => {
                    const percentage = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                    const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-red-500', 'bg-indigo-500'];
                    const maxLength = window.innerWidth < 640 ? 10 : 15;

                    return `
                        <div class="flex items-center justify-between p-3 sm:p-4 bg-white rounded-xl shadow-sm border animate-slide-up hover:shadow-md transition-all duration-200" 
                             style="animation-delay: ${index * 100}ms">
                            <div class="flex items-center space-x-3 min-w-0 flex-1">
                                <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full ${colors[index]} flex items-center justify-center text-white font-bold text-sm sm:text-base flex-shrink-0">
                                    ${index + 1}
                                </div>
                                <div class="min-w-0 flex-1">
                                    <p class="font-semibold text-gray-800 text-sm sm:text-base truncate" title="${item.provinsi}">
                                        ${this.truncateLabel(item.provinsi, maxLength)}
                                    </p>
                                    <p class="text-xs text-gray-500">${percentage}% dari total</p>
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <p class="font-bold text-gray-800 text-base sm:text-lg">${item.count}</p>
                                <p class="text-xs text-gray-500">anggota</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateLeadershipStats(data) {
                const container = document.getElementById('leadershipStats');
                if (!container) return;

                if (data.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-4">Data tidak tersedia</div>';
                    return;
                }

                const total = data.reduce((sum, item) => sum + item.count, 0);

                container.innerHTML = data.map((item, index) => {
                    const percentage = total > 0 ? ((item.count / total) * 100).toFixed(1) : 0;
                    const icons = {
                        'Ketua': 'fas fa-crown',
                        'Wakil Ketua': 'fas fa-star',
                        'Anggota': 'fas fa-user'
                    };

                    return `
                        <div class="flex items-center justify-between p-3 sm:p-4 bg-white rounded-xl shadow-sm border animate-slide-up hover:shadow-md transition-all duration-200" 
                             style="animation-delay: ${index * 100}ms">
                            <div class="flex items-center space-x-3 min-w-0 flex-1">
                                <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                                    <i class="${icons[item.jabatan_type] || 'fas fa-user'} text-indigo-600 text-sm sm:text-base"></i>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <p class="font-semibold text-gray-800 text-sm sm:text-base">${item.jabatan_type}</p>
                                    <p class="text-xs text-gray-500">${percentage}% dari total</p>
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <p class="font-bold text-gray-800 text-base sm:text-lg">${item.count}</p>
                                <p class="text-xs text-gray-500">orang</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            setupEventListeners() {
                // Export CSV button
                const exportCSV = document.getElementById('exportCSV');
                const refreshData = document.getElementById('refreshData');

                if (exportCSV) {
                    exportCSV.addEventListener('click', () => this.exportData());
                }

                if (refreshData) {
                    refreshData.addEventListener('click', () => this.refreshDashboard());
                }
            }

            async exportData() {
                const progressDiv = document.getElementById('exportProgress');
                const statusText = document.getElementById('exportStatus');
                const exportBtn = document.getElementById('exportCSV');

                if (!progressDiv || !exportBtn) return;

                try {
                    const originalText = exportBtn.innerHTML;
                    exportBtn.disabled = true;
                    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3 text-xl"></i><span>Exporting...</span>';

                    progressDiv.classList.remove('hidden');
                    this.updateProgress(20, 'Menghubungi server...');

                    await this.delay(300);
                    this.updateProgress(60, 'Mengunduh CSV...');

                    const response = await fetch(`${this.API_CONFIG.BASE_URL}${this.API_CONFIG.ENDPOINTS.EXPORT}`);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    this.updateProgress(80, 'Memproses file...');
                    const blob = await response.blob();

                    await this.delay(200);
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'dpr_data_export.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    this.updateProgress(100, 'Download selesai!');
                    setTimeout(() => progressDiv.classList.add('hidden'), 2000);

                } catch (error) {
                    console.error('Export error:', error);
                    statusText.textContent = 'Export gagal: ' + (error.message || 'Unknown error');
                    setTimeout(() => progressDiv.classList.add('hidden'), 3000);
                } finally {
                    if (exportBtn) {
                        exportBtn.disabled = false;
                        exportBtn.innerHTML = '<i class="fas fa-table mr-3 text-xl"></i><span>Download CSV</span>';
                    }
                }
            }

            async refreshDashboard() {
                const refreshBtn = document.getElementById('refreshData');
                if (!refreshBtn) return;

                try {
                    const originalText = refreshBtn.innerHTML;
                    refreshBtn.disabled = true;
                    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3 text-xl"></i><span>Refreshing...</span>';

                    // Destroy existing charts
                    Object.values(this.charts).forEach(chart => {
                        if (chart) chart.destroy();
                    });
                    this.charts = {};

                    // Reload dashboard
                    await this.initDashboard();

                } catch (error) {
                    console.error('Refresh error:', error);
                    this.showMessage('Gagal refresh dashboard: ' + (error.message || 'Unknown error'), 'error');
                } finally {
                    if (refreshBtn) {
                        refreshBtn.disabled = false;
                        refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-3 text-xl"></i><span>Refresh Dashboard</span>';
                    }
                }
            }

            updateProgress(percent, status) {
                const progressBar = document.getElementById('exportProgressBar');
                const statusText = document.getElementById('exportStatus');

                if (progressBar) progressBar.style.width = percent + '%';
                if (statusText) statusText.textContent = status;
            }

            showMessage(message, type = 'info') {
                const colors = {
                    success: 'bg-green-100 border-green-300 text-green-700',
                    error: 'bg-red-100 border-red-300 text-red-700',
                    info: 'bg-blue-100 border-blue-300 text-blue-700'
                };

                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };

                const messageDiv = document.createElement('div');
                messageDiv.className = 'fixed top-20 right-4 z-50 animate-slide-up';
                messageDiv.innerHTML = `
                    <div class="${colors[type]} px-6 py-4 rounded-xl border-2 shadow-xl flex items-center space-x-3 max-w-sm">
                        <i class="fas ${icons[type]} text-xl"></i>
                        <span class="font-medium">${message}</span>
                    </div>
                `;

                document.body.appendChild(messageDiv);

                setTimeout(() => {
                    messageDiv.remove();
                }, 4000);
            }

            showNoDataChart(ctx, message) {
                const context = ctx.getContext('2d');
                context.font = '16px Arial';
                context.fillStyle = '#6B7280';
                context.textAlign = 'center';
                context.fillText(message, ctx.width / 2, ctx.height / 2);
            }

            truncateLabel(text, maxLength) {
                if (!text) return 'N/A';
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength - 3) + '...';
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new DPRDashboard();
        });
    </script>
</body>

</html>
